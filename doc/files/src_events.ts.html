<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\events.ts - Event Calendar</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">Event Calendar: src\events.ts</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../modules/Calendar.html">Calendar</a>
                            </li>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/Dialog.html">Dialog</a></li>
                            <li><a href="../classes/EventCalendar.html">EventCalendar</a></li>
                            <li><a href="../classes/Events.html">Events</a></li>
                            <li><a href="../classes/Header.html">Header</a></li>
                            <li><a href="../classes/Helpers.html">Helpers</a></li>
                            <li><a href="../classes/ModalTemplate.html">ModalTemplate</a></li>
                            <li><a href="../classes/MonthCalendar.html">MonthCalendar</a></li>
                            <li><a href="../classes/MoveAction.html">MoveAction</a></li>
                            <li><a href="../classes/Popover.html">Popover</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>src\actions.ts/<ul></ul></li><li>src\calendar.ts/<ul></ul></li><li>src\events.ts/<ul></ul></li><li>src\header.ts/<ul></ul></li><li>src\helpers.ts/<ul></ul></li><li>src\modal.ts/<ul></ul></li><li>src\months.ts/<ul></ul></li><li>src\popover.ts/<ul></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>src\events.ts</h4>

<pre class="code prettyprint linenums">
///&lt;reference path=&quot;../typing/jquery.d.ts&quot; /&gt;
///&lt;reference path=&quot;../typing/moment.d.ts&quot; /&gt;
///&lt;reference path=&quot;common.ts&quot; /&gt;
///&lt;reference path=&quot;helpers.ts&quot; /&gt;
///&lt;reference path=&quot;modal.ts&quot; /&gt;
///&lt;reference path=&quot;popover.ts&quot; /&gt;

module Calendar {

    /**
     * Implements mouse event handlers and provides selected range
     * of days indexes and sets selected class. Show modal dialog with
     * custom setting when user can select one event and type message
     * for other person and/or note to himself. After receiving response from
     * modal dialog there is made design changes in calendar and calls
     * method which provides custom server side request.
     *
     * @class Events
     * @constructor
     * @param {JQuery} element - Calendar jquery element
     * @param {ISettings} settings - Plugin settings
     */
    export class Events {
        /**
         * jQuery element.
         *
         * @property element
         * @type {JQuery}
         */
        element: JQuery;

        /**
         * Plugin settings.
         *
         * @property settings
         * @type {ISettings}
         */
        settings: ISettings;

        /**
         * Object with start and end index. Indexes represents the number of day in year.
         *
         * @property indexes
         * @type {IArrayIndexes}
         */
        indexes: IArrayIndexes;

        /**
         * Selected year.
         *
         * @property year
         * @type {number}
         */
        year: number;

        /**
         * Modal dialog settings.
         *
         * @property dialogSettings
         * @type {IModalDialog}
         */
        dialogSettings: IModalDialog = {
            start: null,
            end: null,
            events: [],
            selectedEvent: &quot;&quot;,
            defaultBgColor: &quot;#5CB85C&quot;,
            defaultColor: &quot;white&quot;,
            localization: null
        };

        constructor(element: JQuery, settings: ISettings) {
            this.element = element;
            this.settings = settings;
            this.dialogSettings.localization = this.settings.localization;
            this.dialogSettings.events = this.settings.events;
            this.dialogSettings.selectedEvent = this.settings.events[0].name;
            this.resetIndexes();

            if(this.settings.editable) {
                this.element.on(&quot;mouseup mouseover mousedown&quot;, &quot;td.cell&quot;, (e) =&gt; {
                    this[e.type](e);
                });
            }
        }

        /**
         * Sets selected year to local variable.
         *
         * @method setSelectedlYear
         * @param {number} year - Selected year
         */
        setSelectedlYear(year: number): void {
            this.year = year;
        }

        /**
         * Implements mousedown event. Sets start index and adds selected class to actual cell.
         *
         * @method mousedown
         * @param {JQueryEventObject} e - Event handler object
         */
        mousedown(e: JQueryEventObject): void {
            if(!this.leftMousePressed(e)) return;

            e.preventDefault();
            var cellElement = $(e.target).closest(&#x27;td&#x27;),
                index = cellElement.attr(&#x27;data-year-day&#x27;);

            if(!index) return;

            $(&#x27;td.cell&#x27;).removeClass(&#x27;selected-day&#x27;);
            this.indexes = {start: Number(index), end: Number(index)};
            cellElement.addClass(&#x27;selected-day&#x27;);
        }

        /**
         * Implements mouseover event. Sets end index, calculates range of selected cells
         * and adds selected class to all cells according to calculated range.
         *
         * @method mouseover
         * @param {JQueryEventObject} e - Event handler object
         */
        mouseover(e: JQueryEventObject): void {
            e.preventDefault();

            if(!this.indexes.start) return;

            var cellElement = $(e.target).closest(&#x27;td&#x27;),
                index = cellElement.attr(&#x27;data-year-day&#x27;);

            if(isNaN(Number(index))) return;

            this.indexes.end = Number(index);
            if(this.indexes.start !== this.indexes.end) {
                $(&#x27;td.cell&#x27;).removeClass(&#x27;selected-day&#x27;);
                var idx = Calendar.Helpers.ArrayIndexes(this.indexes),
                    selectedRange = Calendar.Helpers.ArrayRange(idx.start, idx.end);

                selectedRange.forEach((item) =&gt; {
                    var selector = &#x27;td.cell[data-year-day=&#x27; + item + &#x27;]&#x27;;
                    $(selector).addClass(&#x27;selected-day&#x27;);
                });
            }
        }

        /**
         * Implements mouseup event. Sets end index, calculates start and end dates
         * from indexes and calls modal dialog to enter personal event. At the end resets start and end indexes.
         *
         * @method mouseup
         * @param {JQueryEventObject} e - Event handler object
         */
        mouseup(e: JQueryEventObject): void {
            e.preventDefault();

            if(!this.indexes.start || !this.indexes.end) return;

            var idx = Calendar.Helpers.ArrayIndexes(this.indexes);
            this.dialogSettings.start = moment([this.year]).dayOfYear(idx.start);
            this.dialogSettings.end = moment([this.year]).dayOfYear(idx.end);

            this.showModal();
        }

        /**
         * Displays modal dialog with settings and action and handlers events &quot;Submit&quot; or &quot;Delete&quot;
         * based on clicked button. After that calls removing selection styling.
         *
         * @method showModal
         */
        showModal(): void {
            var modal = new Dialog(this.dialogSettings);
            modal.show().then((result) =&gt; {
                if(result === DialogResult.Submit) {
                    this.dialogSettings = modal.dialogSettings;
                    this.submitChanges();
                } else if (result === DialogResult.Delete) {
                    this.deleteItems();
                }

                this.removeSelection();
            });
        }

        /**
         * Removes class &#x60;selected-day&#x60; used for marking selection and calls &#x60;resetIndexes()&#x60;.
         *
         * @method removeSelection
         *
         */
        removeSelection(): void {
            this.element.find(&quot;td&quot;).removeClass(&quot;selected-day&quot;);
            this.resetIndexes();
            this.dialogSettings.personalNote = null;
            this.dialogSettings.message = null;
            this.dialogSettings.selectedEvent = this.settings.events[0].name;
        }

        /**
         * Submit action. Applies css style for selected event on client side.
         * Calls &#x60;TODO: Submit server implementation&#x60; for server side implementation.
         *
         * @method submitChanges
         */
        submitChanges(): void {
            // user implementation
            this.applyEventFormat();
        }

        /**
         * Delete action. Remove css style on client side.
         * Calls &#x60;TODO: Delete server implementation&#x60; for server side implementation.
         *
         * @method deleteItems
         */
        deleteItems(): void {
            // user implementation
            this.removeEventFormat();

        }

        /**
         * Sets css styling to each cell in range of selected indexes according to
         * selected event and its properties (background color, color), sets title
         * if any of messages is typed. Adds class &#x60;event-day&#x60; to each cell and initializes
         * popover with messages.
         *
         * @method applyEventFormat
         */
        applyEventFormat(): void {
            var selectedEvent = this.dialogSettings.events.filter((item) =&gt; item.name === this.dialogSettings.selectedEvent),
                oneEvent = selectedEvent[0],
                bgr = oneEvent[&quot;backgroundColor&quot;] || this.dialogSettings.defaultBgColor,
                color = oneEvent[&quot;color&quot;] || this.dialogSettings.defaultColor,
                message = this.dialogSettings.message || null,
                note = this.settings.editable &amp;&amp; this.dialogSettings.personalNote ? this.dialogSettings.personalNote : null,
                eventRange = Calendar.Helpers.ArrayRange(this.indexes.start, this.indexes.end);

            eventRange.forEach((item) =&gt; {
                var cell = $(&#x27;td.cell[data-year-day=&#x27; + item + &#x27;]&#x27;);
                cell.addClass(&#x27;event-day&#x27;);
                cell.css({ &quot;background-color&quot;: bgr, &quot;color&quot;: color });
                if(message || note) {
                    Calendar.Popover.popover(cell, message, note);
                }
            });
        }

        /**
         * Removes css styling and attribute &#x60;title&#x60; from selected cells
         * and destroys popover with messages.
         *
         * @method removeEventFormat
         */
        removeEventFormat(): void {
            var eventRange = Calendar.Helpers.ArrayRange(this.indexes.start, this.indexes.end);
            eventRange.forEach((item) =&gt; {
                var cell = $(&#x27;td.cell[data-year-day=&#x27; + item + &#x27;]&#x27;);
                cell.css({ &quot;background-color&quot;: &quot;&quot;, &quot;color&quot;: &quot;&quot; });
                cell.removeAttr(&quot;title&quot;);
                Calendar.Popover.destroy(cell);
            });
        }

        /**
         * Marks specified cells with css format and adds popover
         * in case message or note for cell is available.
         *
         * @method dataEventFormat
         * @static
         * @param {Array&lt;IData&gt;} data - Server data to select correct cells and apply correct css format
         * @param {Array&lt;IEvent&gt;} events - List of available events
         * @param {number} year - Actual selected year
         */
        static dataEventFormat(data: Array&lt;IData&gt;, events: Array&lt;IEvent&gt;, year: number): void {
            data.forEach((item) =&gt; {
                var date = moment(item.date);

                if(date.isValid() &amp;&amp; date.year() === year) {
                    var listEv = events.filter(ev =&gt; ev.name.toLocaleLowerCase() === item.event.toLocaleLowerCase()),
                        currentEvent = listEv.length ? listEv[0] : events[0],
                        yearDay = date.dayOfYear(),
                        cell = $(&#x27;td.cell[data-year-day=&#x27; + yearDay + &#x27;]&#x27;);

                    cell.addClass(&#x27;event-day&#x27;);
                    cell.css({ &quot;background-color&quot;: currentEvent.backgroundColor, &quot;color&quot;: currentEvent.color });
                    if(item.message || item.note) {
                        Calendar.Popover.popover(cell, item.message, item.note);
                    }
                }
            });
        }

        /**
         * Resolves left mouse pressing.
         *
         * @method leftMousePressed
         * @private
         * @param {JQueryEventObject} e - Event handler object
         * @return {boolean} - Whether the left mouse button has been pressed
         */
        private leftMousePressed(e: JQueryEventObject): boolean {
            var event = window.event;
            var button = e.which || event.button;
            return button === 1;
        }

        /**
         * Remove values from &#x60;this.index&#x60; property after &#x60;mouseup&#x60; event
         * to use for other selection.
         *
         * @method resetIndexes
         * @private
         */
        private resetIndexes(): void {
            this.indexes = { start: null, end: null };
        }
    }
}
</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
